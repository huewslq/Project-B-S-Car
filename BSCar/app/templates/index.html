<!doctype html>
<html lang="ru">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>{{ title }}</title>
	<link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
	<aside class="sidebar">
		<a class="nav-button {% if request.path=='/' %}is-active{% endif %}" href="/" aria-label="домой" title="домой">
			<img src="{{ url_for('static', filename='img/icon-home.svg') }}" alt="домой">
		</a>
		<a class="nav-button {% if request.path.startswith('/favorites') %}is-active{% endif %}" href="{{ url_for('main.favorites') }}" aria-label="избранное" title="избранное">
			<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24">
				<path fill="currentColor" fill-rule="evenodd" d="M5.624 4.424C3.965 5.182 2.75 6.986 2.75 9.137c0 2.197.9 3.891 2.188 5.343c1.063 1.196 2.349 2.188 3.603 3.154q.448.345.885.688c.526.415.995.778 1.448 1.043s.816.385 1.126.385s.674-.12 1.126-.385c.453-.265.922-.628 1.448-1.043q.437-.344.885-.687c1.254-.968 2.54-1.959 3.603-3.155c1.289-1.452 2.188-3.146 2.188-5.343c0-2.15-1.215-3.955-2.874-4.713c-1.612-.737-3.778-.542-5.836 1.597a.75.75 0 0 1-1.08 0C9.402 3.882 7.236 3.687 5.624 4.424M12 4.46C9.688 2.39 7.099 2.1 5 3.059C2.786 4.074 1.25 6.426 1.25 9.138c0 2.665 1.11 4.699 2.567 6.339c1.166 1.313 2.593 2.412 3.854 3.382q.43.33.826.642c.513.404 1.063.834 1.62 1.16s1.193.59 1.883.59s1.326-.265 1.883-.59c.558-.326 1.107-.756 1.62-1.16q.396-.312.826-.642c1.26-.97 2.688-2.07 3.854-3.382c1.457-1.64 2.567-3.674 2.567-6.339c0-2.712-1.535-5.064-3.75-6.077c-2.099-.96-4.688-.67-7 1.399" clip-rule="evenodd"/>
			</svg>
		</a>
		<a class="nav-button {% if request.path.startswith('/chats') %}is-active{% endif %}" href="{{ url_for('main.chats') }}" aria-label="чаты" title="чаты">
			<img src="{{ url_for('static', filename='img/icon-chat.svg') }}" alt="чаты">
		</a>
		{% if is_admin %}
		<a class="nav-button {% if request.path.startswith('/admin') %}is-active{% endif %}" href="{{ url_for('main.admin_panel') }}" aria-label="админ" title="админ">
			<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" aria-hidden="true">
				<path fill="currentColor" d="m9.25 22l-.4-3.2q-.325-.125-.612-.3t-.563-.375L4.7 19.375l-2.75-4.75l2.575-1.95Q4.5 12.5 4.5 12.338v-.675q0-.163.025-.338L1.95 9.375l2.75-4.75l2.975 1.25q.275-.2.575-.375t.6-.3l.4-3.2h5.5l.4 3.2q.325.125.613.3t.562.375l2.975-1.25l2.75 4.75l-2.575 1.95q.025.175.025.338v.674q0 .163-.05.338l2.575 1.95l-2.75 4.75l-2.95-1.25q-.275.2-.575.375t-.6.3l-.4 3.2zM11 20h1.975l.35-2.65q.775-.2 1.438-.587t1.212-.938l2.475 1.025l.975-1.7l-2.15-1.625q.125-.35.175-.737T17.5 12t-.05-.787t-.175-.738l2.15-1.625l-.975-1.7l-2.475 1.05q-.55-.575-1.212-.962t-1.438-.588L13 4h-1.975l-.35 2.65q-.775.2-1.437.588t-1.213.937L5.55 7.15l-.975 1.7l2.15 1.6q-.125.375-.175.75t-.05.8q0 .4.05.775t.175.75l-2.15 1.625l.975 1.7l2.475-1.05q.55.575 1.213.963t1.437.587zm1.05-4.5q1.45 0 2.475-1.025T15.55 12t-1.025-2.475T12.05 8.5q-1.475 0-2.488 1.025T8.55 12t1.013 2.475T12.05 15.5M12 12"/>
			</svg>
		</a>
		{% endif %}
		<a class="nav-button profile {% if request.path.startswith('/account') %}is-active{% endif %}" href="{{ url_for('main.account') }}" aria-label="аккаунт" title="аккаунт">
			{% if current_user and current_user.avatar_filename %}
				<img class="avatar" src="{{ url_for('static', filename='uploads/avatars/' + current_user.avatar_filename) }}" alt="аккаунт">
			{% else %}
				<img class="avatar" src="{{ url_for('static', filename='img/avatar.png') }}" alt="аккаунт">
			{% endif %}
		</a>
	</aside>

	<div class="page">
		{% if mode == 'listings' %}
		<header class="topbar">
			<div class="brand">
				<picture>
					<source type="image/png" srcset="{{ url_for('static', filename='img/logo.png') }}">
					<img class="logo" src="{{ url_for('static', filename='img/logo.svg') }}" alt="B&S CAR">
				</picture>
				<h1>B&S CAR</h1>
			</div>
			<form class="search" method="GET" action="{{ url_for('main.index') }}">
				<img src="{{ url_for('static', filename='img/icon-search.svg') }}" alt="поиск">
				<input type="search" name="search" placeholder="поиск" aria-label="поиск" value="{{ search_query or '' }}">
				{% if category_filter != 'all' %}
				<input type="hidden" name="category" value="{{ category_filter }}">
				{% endif %}
			</form>
		</header>
		{% endif %}

		<main class="content">
			{% with messages = get_flashed_messages(with_categories=True) %}
			{% if messages %}
			<div class="flash-messages">
				{% for category, message in messages %}
				<div class="flash-message {{ category }}">{{ message }}</div>
				{% endfor %}
			</div>
			{% endif %}
			{% endwith %}
			
			{% if mode == 'listings' %}
			{% if search_query %}
			<div class="search-results">
				<h2 class="headline">Результаты поиска по запросу "{{ search_query }}"</h2>
				<p class="search-info">Найдено объявлений: {{ listings|length }}</p>
				<a href="{{ url_for('main.index', category=current_filter) }}" class="clear-search">✕ Очистить поиск</a>
			</div>
			{% else %}
			<h2 class="headline">Лучшие машины здесь!</h2>
			{% endif %}
			<div class="chips">
				<a href="{{ url_for('main.index', category='all', search=search_query) }}" class="chip {% if current_filter == 'all' %}is-active{% endif %}">
					★ Все <span class="count">({{ stats.all }})</span>
				</a>
				<a href="{{ url_for('main.index', category='new', search=search_query) }}" class="chip {% if current_filter == 'new' %}is-active{% endif %}">
					✚ Новые <span class="count">({{ stats.new }})</span>
				</a>
				<a href="{{ url_for('main.index', category='used', search=search_query) }}" class="chip {% if current_filter == 'used' %}is-active{% endif %}">
					☆ Б/У <span class="count">({{ stats.used }})</span>
				</a>
			</div>
			{% elif mode == 'favorites' %}
			<h2 class="headline">Избранное</h2>
			{% elif mode == 'chats' %}
			<h2 class="headline">Чаты</h2>
			{% elif mode == 'account' %}
			<h2 class="headline">Профиль</h2>
			{% elif mode == 'my' %}
			<h2 class="headline">Мои объявления</h2>
			{% elif mode == 'new' %}
			<h2 class="headline">Создать объявление</h2>
			{% elif mode == 'account_edit' %}
			<section class="form-section">
				<form method="POST" action="{{ url_for('main.edit_profile_post') }}" enctype="multipart/form-data" class="listing-form">
					<div class="form-group">
						<label for="name">Имя</label>
						<input type="text" id="name" name="name" value="{{ user.name }}" required>
					</div>
					<div class="form-group">
						<label for="email">Email</label>
						<input type="email" id="email" name="email" value="{{ user.email }}" required>
					</div>
					<div class="form-group">
						<label for="avatar">Аватар</label>
						<input type="file" id="avatar" name="avatar" accept="image/*">
					</div>
					<div class="form-actions">
						<button type="submit" class="btn btn-primary">Сохранить</button>
						<a href="{{ url_for('main.account') }}" class="btn btn-secondary">Отмена</a>
					</div>
				</form>
			</section>
			{% elif mode == 'listing_detail' %}
			<h2 class="headline">{{ listing.title }}</h2>
			{% elif mode == 'chat_detail' %}
			<h2 class="headline">Чат с {{ other_user.name or other_user.email }}</h2>
			{% elif mode == 'support' %}
			<section class="support-section">
				{% if is_admin %}
				<div class="admin-support">
					<h3>Ответы на обращения</h3>
					{% if support_tickets %}
					<div class="support-tickets">
						{% for ticket in support_tickets %}
						<div class="ticket-card">
							<div class="ticket-header">
								<h4>{{ ticket.subject }}</h4>
								<span class="ticket-status">{{ ticket.status }}</span>
							</div>
							<p class="ticket-message">{{ ticket.message }}</p>
							<div class="ticket-meta">
								<span>От: {{ ticket.user.name or ticket.user.email }}</span>
								<span>{{ ticket.created_at.strftime('%d.%m.%Y %H:%M') }}</span>
							</div>
							{% if ticket.status == 'pending' %}
							<form method="POST" action="{{ url_for('main.reply_support', ticket_id=ticket.id) }}" class="reply-form">
								<textarea name="reply" placeholder="Ответ техподдержки..." required></textarea>
								<button type="submit" class="btn btn-primary">Ответить</button>
							</form>
							{% endif %}
						</div>
						{% endfor %}
					</div>
					{% else %}
					<p>Нет обращений в техподдержку</p>
					{% endif %}
				</div>
				{% else %}
				<div class="user-support">
					<h3>Написать в техподдержку</h3>
					<form method="POST" action="{{ url_for('main.create_support_ticket') }}" class="support-form">
						<div class="form-group">
							<label for="subject">Тема обращения</label>
							<input type="text" id="subject" name="subject" required placeholder="Кратко опишите проблему">
						</div>
						<div class="form-group">
							<label for="message">Сообщение</label>
							<textarea id="message" name="message" rows="5" required placeholder="Подробно опишите вашу проблему или вопрос"></textarea>
						</div>
						<button type="submit" class="btn btn-primary">Отправить обращение</button>
					</form>
					
					{% if user_tickets %}
					<h3>Мои обращения</h3>
					<div class="user-tickets">
						{% for ticket in user_tickets %}
						<div class="ticket-card">
							<div class="ticket-header">
								<h4>{{ ticket.subject }}</h4>
								<span class="ticket-status">{{ ticket.status }}</span>
							</div>
							<p class="ticket-message">{{ ticket.message }}</p>
							{% if ticket.reply %}
							<div class="ticket-reply">
								<strong>Ответ техподдержки:</strong>
								<p>{{ ticket.reply }}</p>
							</div>
							{% endif %}
							<div class="ticket-meta">
								<span>{{ ticket.created_at.strftime('%d.%m.%Y %H:%M') }}</span>
							</div>
						</div>
						{% endfor %}
					</div>
					{% endif %}
				</div>
				{% endif %}
			</section>
			{% elif mode == 'admin' %}
			<h2 class="headline">Админ-панель</h2>
			<section class="admin-panel">
				<div class="admin-actions">
					<div class="admin-section">
						<h3>Управление пользователями</h3>
						<div class="admin-buttons">
							<button class="btn btn-primary" onclick="showAddAdminForm()">Добавить админа</button>
							<button class="btn btn-secondary" onclick="showBlockUserForm()">Заблокировать пользователя</button>
						</div>
					</div>
					
					<div class="admin-section">
						<h3>Управление объявлениями</h3>
						<div class="admin-buttons">
							<button class="btn btn-danger" onclick="showDeleteListingForm()">Удалить объявление</button>
						</div>
					</div>
					
					<div class="admin-section">
						<h3>Техподдержка</h3>
						<div class="admin-buttons">
							<a href="{{ url_for('main.support') }}" class="btn btn-primary">Ответить на обращения</a>
						</div>
					</div>
				</div>
				
				<div id="add-admin-form" class="admin-form" style="display: none;">
					<h4>Добавить админа</h4>
					<form method="POST" action="{{ url_for('main.add_admin') }}">
						<div class="form-group">
							<label for="admin_email">Email пользователя</label>
							<input type="email" id="admin_email" name="email" required>
						</div>
						<div class="form-actions">
							<button type="submit" class="btn btn-primary">Назначить админом</button>
							<button type="button" class="btn btn-secondary" onclick="hideAddAdminForm()">Отмена</button>
						</div>
					</form>
				</div>
				
				<div id="block-user-form" class="admin-form" style="display: none;">
					<h4>Заблокировать пользователя</h4>
					<form method="POST" action="{{ url_for('main.block_user') }}">
						<div class="form-group">
							<label for="block_email">Email пользователя</label>
							<input type="email" id="block_email" name="email" required>
						</div>
						<div class="form-group">
							<label for="block_reason">Причина блокировки</label>
							<textarea id="block_reason" name="reason" rows="3" required></textarea>
						</div>
						<div class="form-actions">
							<button type="submit" class="btn btn-danger">Заблокировать</button>
							<button type="button" class="btn btn-secondary" onclick="hideBlockUserForm()">Отмена</button>
						</div>
					</form>
				</div>
				
				<div id="delete-listing-form" class="admin-form" style="display: none;">
					<h4>Удалить объявление</h4>
					<form method="POST" action="{{ url_for('main.delete_listing') }}">
						<div class="form-group">
							<label for="listing_id">ID объявления</label>
							<input type="number" id="listing_id" name="listing_id" required>
						</div>
						<div class="form-group">
							<label for="delete_reason">Причина удаления</label>
							<textarea id="delete_reason" name="reason" rows="3" required></textarea>
						</div>
						<div class="form-actions">
							<button type="submit" class="btn btn-danger">Удалить объявление</button>
							<button type="button" class="btn btn-secondary" onclick="hideDeleteListingForm()">Отмена</button>
						</div>
					</form>
				</div>
			</section>
			{% elif mode == 'account_edit' %}
			<h2 class="headline">Изменить профиль</h2>
			{% endif %}

			{% if mode == 'listings' or mode == 'favorites' or mode == 'my' %}
			{% if listings and listings|length %}
			{% if mode == 'my' %}
			<div class="action-bar">
				<a class="btn btn-primary" href="{{ url_for('main.new_listing') }}">Создать объявление</a>
			</div>
			{% endif %}
			<section class="grid">
				{% for item in listings %}
				<article class="card clickable-card" onclick="window.location.href='{{ url_for('main.view_listing', listing_id=item.id) }}'">
					<div class="thumb">
						{% if item.images %}
							{% set primary_image = item.images | selectattr('is_primary') | first %}
							{% if primary_image %}
								<img src="{{ url_for('main.uploaded_file', filename=primary_image.filename) }}" alt="{{ item.title }}">
							{% else %}
								<img src="{{ url_for('main.uploaded_file', filename=item.images[0].filename) }}" alt="{{ item.title }}">
							{% endif %}
						{% else %}
							<img src="{{ url_for('static', filename='img/placeholder.svg') }}" alt="car">
						{% endif %}
					</div>
					<h3>{{ item.title or 'Без названия' }}</h3>
					{% if item.price %}
					<p class="price">{{ "{:,.0f}".format(item.price) }} ₽</p>
					{% endif %}
					{% if item.description %}
					<p class="description">{{ item.description[:100] }}{% if item.description|length > 100 %}...{% endif %}</p>
					{% endif %}
					<p class="sub">{{ item.updated_at.strftime('%Y-%m-%d %H:%M') if item.updated_at else '' }}</p>
				</article>
				{% endfor %}
			</section>
			{% else %}
			<div class="empty">
				<span class="emoji">🏁</span>
				<h3>Нет активных объявлений</h3>
				<p>Добавьте объявления или загляните позже</p>
				{% if mode == 'my' %}
				<div class="actions">
					<a class="btn btn-primary" href="{{ url_for('main.new_listing') }}">Создать объявление</a>
				</div>
				{% endif %}
			</div>
			{% endif %}
			{% elif mode == 'chats' %}
			{% if chats and chats|length %}
			<section class="chats-list">
				{% for chat in chats %}
				<article class="chat-card" onclick="window.location.href='{{ url_for('main.view_chat', chat_id=chat.id) }}'">
					<div class="chat-info">
						<h3>{{ chat.listing.title if chat.listing else 'Объявление #' + chat.listing_id|string }}</h3>
						<p class="chat-participants">
							{% if chat.buyer_id == session.user_id %}
								Продавец: {{ chat.seller.name or chat.seller.email }}
							{% else %}
								Покупатель: {{ chat.buyer.name or chat.buyer.email }}
							{% endif %}
						</p>
						<p class="sub">{{ chat.updated_at.strftime('%d.%m.%Y %H:%M') if chat.updated_at else '' }}</p>
					</div>
					<div class="chat-arrow">→</div>
				</article>
				{% endfor %}
			</section>
			{% else %}
			<div class="empty">
				<span class="emoji">💬</span>
				<h3>Нет чатов</h3>
				<p>Напишите продавцу, когда найдёте подходящее авто</p>
			</div>
			{% endif %}
			{% elif mode == 'account' %}
			<section>
				<div class="profile-card">
					<div class="profile-header">
						{% if user.avatar_filename %}
						<img class="avatar" src="{{ url_for('static', filename='uploads/avatars/' + user.avatar_filename) }}" alt="avatar">
						{% else %}
						<img class="avatar" src="{{ url_for('static', filename='img/avatar.png') }}" alt="avatar">
						{% endif %}
						<div>
							<h3 class="name">{{ user.name or 'Профиль' }}</h3>
							<p class="sub">{{ user.email or '' }}</p>
						</div>
					</div>
				</div>

				<nav class="profile-menu">
					<a class="profile-item" href="{{ url_for('main.my_listings') }}">
						<img class="icon" src="{{ url_for('static', filename='img/icon-home.svg') }}" alt="">
						<span class="label">Мои объявления</span>
					</a>
					<a class="profile-item" href="{{ url_for('main.favorites') }}">
						<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" class="icon">
							<path fill="currentColor" fill-rule="evenodd" d="M5.624 4.424C3.965 5.182 2.75 6.986 2.75 9.137c0 2.197.9 3.891 2.188 5.343c1.063 1.196 2.349 2.188 3.603 3.154q.448.345.885.688c.526.415.995.778 1.448 1.043s.816.385 1.126.385s.674-.12 1.126-.385c.453-.265.922-.628 1.448-1.043q.437-.344.885-.687c1.254-.968 2.54-1.959 3.603-3.155c1.289-1.452 2.188-3.146 2.188-5.343c0-2.15-1.215-3.955-2.874-4.713c-1.612-.737-3.778-.542-5.836 1.597a.75.75 0 0 1-1.08 0C9.402 3.882 7.236 3.687 5.624 4.424M12 4.46C9.688 2.39 7.099 2.1 5 3.059C2.786 4.074 1.25 6.426 1.25 9.138c0 2.665 1.11 4.699 2.567 6.339c1.166 1.313 2.593 2.412 3.854 3.382q.43.33.826.642c.513.404 1.063.834 1.62 1.16s1.193.59 1.883.59s1.326-.265 1.883-.59c.558-.326 1.107-.756 1.62-1.16q.396-.312.826-.642c1.26-.97 2.688-2.07 3.854-3.382c1.457-1.64 2.567-3.674 2.567-6.339c0-2.712-1.535-5.064-3.75-6.077c-2.099-.96-4.688-.67-7 1.399" clip-rule="evenodd"/>
						</svg>
						<span class="label">Избранное</span>
					</a>
					<a class="profile-item" href="{{ url_for('main.chats') }}">
						<img class="icon" src="{{ url_for('static', filename='img/icon-chat.svg') }}" alt="">
						<span class="label">Чаты</span>
					</a>
					<a class="profile-item" href="{{ url_for('main.support') }}">
						<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" class="icon">
							<path fill="currentColor" d="M2 22V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18H6zm3.15-6H20V4H4v13.125zM4 16V4z"/>
						</svg>
						<span class="label">Техподдержка</span>
					</a>
					<a class="profile-item" href="{{ url_for('main.edit_profile') }}">
						<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" class="icon">
							<path fill="currentColor" d="m9.25 22l-.4-3.2q-.325-.125-.612-.3t-.563-.375L4.7 19.375l-2.75-4.75l2.575-1.95Q4.5 12.5 4.5 12.338v-.675q0-.163.025-.338L1.95 9.375l2.75-4.75l2.975 1.25q.275-.2.575-.375t.6-.3l.4-3.2h5.5l.4 3.2q.325.125.613.3t.562.375l2.975-1.25l2.75 4.75l-2.575 1.95q.025.175.025.338v.674q0 .163-.05.338l2.575 1.95l-2.75 4.75l-2.95-1.25q-.275.2-.575.375t-.6.3l-.4 3.2zm2.8-6.5q1.45 0 2.475-1.025T15.55 12t-1.025-2.475T12.05 8.5q-1.475 0-2.488 1.025T8.55 12t1.013 2.475T12.05 15.5"/>
						</svg>
						<span class="label">Изменить профиль</span>
					</a>
					<a class="profile-item" href="{{ url_for('main.logout') }}">
						<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" class="icon">
							<path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" d="M19.285 12h-8.012m5.237 3.636L20 12l-3.49-3.636M13.455 7V4H4v16h9.455v-3"/>
						</svg>
						<span class="label">Выйти</span>
					</a>
				</nav>
			</section>
			{% elif mode == 'new' %}
			<section class="form-section">
				<form method="POST" action="{{ url_for('main.create_listing') }}" enctype="multipart/form-data" class="listing-form">
					<div class="form-group">
						<label for="title">Название объявления *</label>
						<input type="text" id="title" name="title" required placeholder="Например: BMW X5 2020 года">
					</div>
					
					<div class="form-group">
						<label for="category_id">Категория</label>
						<select id="category_id" name="category_id">
							<option value="">Выберите категорию</option>
							{% for category in categories %}
							<option value="{{ category.id }}">{{ category.name }}</option>
							{% endfor %}
						</select>
					</div>
					
					<div class="form-group">
						<label for="price">Цена (руб.) *</label>
						<input type="number" id="price" name="price" required placeholder="1000000" min="0" step="1000">
					</div>
					
					<div class="form-group">
						<label for="description">Описание</label>
						<textarea id="description" name="description" rows="5" placeholder="Подробное описание автомобиля, его состояние, комплектация и т.д."></textarea>
					</div>
					
					<div class="form-group">
						<label for="images">Фотографии автомобиля</label>
						<input type="file" id="images" name="images" multiple accept="image/*" class="file-input">
						<div class="file-info">
							<p class="file-hint">Можно загрузить несколько фотографий (PNG, JPG, JPEG, GIF, WebP)</p>
							<p class="file-limit">Максимальный размер файла: 5MB</p>
						</div>
						<div id="image-preview" class="image-preview"></div>
					</div>
					
					<div class="form-actions">
						<button type="submit" class="btn btn-primary">Создать объявление</button>
						<a href="{{ url_for('main.my_listings') }}" class="btn btn-secondary">Отмена</a>
					</div>
				</form>
			</section>
			{% elif mode == 'listing_detail' %}
			<section class="listing-detail">
				<div class="listing-content">
					<div class="listing-images">
						{% if listing.images %}
							<div class="main-image">
								{% set primary_image = listing.images | selectattr('is_primary') | first %}
								{% if primary_image %}
									<img src="{{ url_for('main.uploaded_file', filename=primary_image.filename) }}" alt="{{ listing.title }}" id="main-image">
								{% else %}
									<img src="{{ url_for('main.uploaded_file', filename=listing.images[0].filename) }}" alt="{{ listing.title }}" id="main-image">
								{% endif %}
							</div>
							{% if listing.images|length > 1 %}
							<div class="image-thumbnails">
								{% for image in listing.images %}
								<img src="{{ url_for('main.uploaded_file', filename=image.filename) }}" 
									 alt="{{ listing.title }}" 
									 class="thumbnail {% if image.is_primary %}active{% endif %}"
									 onclick="changeMainImage(this)">
								{% endfor %}
							</div>
							{% endif %}
						{% else %}
							<div class="main-image">
								<img src="{{ url_for('static', filename='img/placeholder.svg') }}" alt="{{ listing.title }}" id="main-image">
							</div>
						{% endif %}
						
						<div class="listing-actions">
							<form method="POST" action="{{ url_for('main.toggle_favorite', listing_id=listing.id) }}" style="display: inline;">
								<button type="submit" class="btn btn-secondary">
									{% if is_favorited %}
										<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" style="margin-right: 8px;">
											<path fill="currentColor" fill-rule="evenodd" d="M5.624 4.424C3.965 5.182 2.75 6.986 2.75 9.137c0 2.197.9 3.891 2.188 5.343c1.063 1.196 2.349 2.188 3.603 3.154q.448.345.885.688c.526.415.995.778 1.448 1.043s.816.385 1.126.385s.674-.12 1.126-.385c.453-.265.922-.628 1.448-1.043q.437-.344.885-.687c1.254-.968 2.54-1.959 3.603-3.155c1.289-1.452 2.188-3.146 2.188-5.343c0-2.15-1.215-3.955-2.874-4.713c-1.612-.737-3.778-.542-5.836 1.597a.75.75 0 0 1-1.08 0C9.402 3.882 7.236 3.687 5.624 4.424M12 4.46C9.688 2.39 7.099 2.1 5 3.059C2.786 4.074 1.25 6.426 1.25 9.138c0 2.665 1.11 4.699 2.567 6.339c1.166 1.313 2.593 2.412 3.854 3.382q.43.33.826.642c.513.404 1.063.834 1.62 1.16s1.193.59 1.883.59s1.326-.265 1.883-.59c.558-.326 1.107-.756 1.62-1.16q.396-.312.826-.642c1.26-.97 2.688-2.07 3.854-3.382c1.457-1.64 2.567-3.674 2.567-6.339c0-2.712-1.535-5.064-3.75-6.077c-2.099-.96-4.688-.67-7 1.399" clip-rule="evenodd"/>
										</svg>
										Удалить из избранного
									{% else %}
										<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" style="margin-right: 8px;">
											<path fill="currentColor" fill-rule="evenodd" d="M5.624 4.424C3.965 5.182 2.75 6.986 2.75 9.137c0 2.197.9 3.891 2.188 5.343c1.063 1.196 2.349 2.188 3.603 3.154q.448.345.885.688c.526.415.995.778 1.448 1.043s.816.385 1.126.385s.674-.12 1.126-.385c.453-.265.922-.628 1.448-1.043q.437-.344.885-.687c1.254-.968 2.54-1.959 3.603-3.155c1.289-1.452 2.188-3.146 2.188-5.343c0-2.15-1.215-3.955-2.874-4.713c-1.612-.737-3.778-.542-5.836 1.597a.75.75 0 0 1-1.08 0C9.402 3.882 7.236 3.687 5.624 4.424M12 4.46C9.688 2.39 7.099 2.1 5 3.059C2.786 4.074 1.25 6.426 1.25 9.138c0 2.665 1.11 4.699 2.567 6.339c1.166 1.313 2.593 2.412 3.854 3.382q.43.33.826.642c.513.404 1.063.834 1.62 1.16s1.193.59 1.883.59s1.326-.265 1.883-.59c.558-.326 1.107-.756 1.62-1.16q.396-.312.826-.642c1.26-.97 2.688-2.07 3.854-3.382c1.457-1.64 2.567-3.674 2.567-6.339c0-2.712-1.535-5.064-3.75-6.077c-2.099-.96-4.688-.67-7 1.399" clip-rule="evenodd"/>
										</svg>
										Добавить в избранное
									{% endif %}
								</button>
							</form>
							
							{% if listing.owner_id != session.user_id %}
							<form method="POST" action="{{ url_for('main.contact_seller', listing_id=listing.id) }}" style="display: inline;">
								<button type="submit" class="btn btn-primary">💬 Написать продавцу</button>
							</form>
							{% endif %}
							
							{% if listing.owner_id != session.user_id %}
							<form method="POST" action="{{ url_for('main.report_listing', listing_id=listing.id) }}" style="display: inline;">
								<button type="submit" class="btn btn-secondary">🚨 Пожаловаться</button>
							</form>
							{% endif %}
							
							{% if is_admin %}
							<form method="POST" action="{{ url_for('main.delete_listing_admin') }}" style="display: inline;" onsubmit="return confirm('Вы уверены, что хотите удалить это объявление?');">
								<input type="hidden" name="listing_id" value="{{ listing.id }}">
								<input type="hidden" name="reason" value="Удалено администратором">
								<button type="submit" class="btn btn-danger">🗑️ Удалить объявление</button>
							</form>
							{% endif %}
							
							<a href="{{ url_for('main.index') }}" class="btn btn-secondary">← Назад к объявлениям</a>
						</div>
					</div>
					
					<div class="listing-info">
						<div class="listing-header">
							<h1>{{ listing.title }} <span class="listing-id">(ID: {{ listing.id }})</span></h1>
							{% if listing.price %}
							<div class="listing-price">{{ "{:,.0f}".format(listing.price) }} ₽</div>
							{% endif %}
						</div>
						
						{% if listing.description %}
						<div class="listing-description">
							<h3>Описание</h3>
							<p>{{ listing.description }}</p>
						</div>
						{% endif %}
						
						<div class="listing-meta">
							<div class="meta-item">
								<strong>Категория:</strong> 
								{% if listing.category %}
									{{ listing.category.name }}
								{% else %}
									Не указана
								{% endif %}
							</div>
							<div class="meta-item">
								<strong>Дата публикации:</strong> 
								{{ listing.created_at.strftime('%d.%m.%Y в %H:%M') if listing.created_at else '' }}
							</div>
							<div class="meta-item">
								<strong>Обновлено:</strong> 
								{{ listing.updated_at.strftime('%d.%m.%Y в %H:%M') if listing.updated_at else '' }}
							</div>
						</div>
						
                        <div class="seller-info">
							<h3>Продавец</h3>
							<div class="seller-card">
                                {% if listing.owner and listing.owner.avatar_filename %}
                                <img class="seller-avatar" src="{{ url_for('static', filename='uploads/avatars/' + listing.owner.avatar_filename) }}" alt="Продавец">
                                {% else %}
                                <img class="seller-avatar" src="{{ url_for('static', filename='img/avatar.png') }}" alt="Продавец">
                                {% endif %}
                                <div class="seller-details">
                                    <div class="seller-name">{{ listing.owner.name or 'Продавец' }}</div>
                                </div>
							</div>
						</div>
					</div>
				</div>
			</section>
			{% elif mode == 'chat_detail' %}
			<section class="chat-detail">
				<div class="chat-header">
					<div class="chat-listing-info">
						<h3>{{ chat.listing.title if chat.listing else 'Объявление #' + chat.listing_id|string }}</h3>
						{% if chat.listing and chat.listing.price %}
						<p class="listing-price">{{ "{:,.0f}".format(chat.listing.price) }} ₽</p>
						{% endif %}
					</div>
					<a href="{{ url_for('main.chats') }}" class="btn btn-secondary">← Назад к чатам</a>
				</div>
				
				<div class="chat-messages" id="chat-messages">
					{% if chat.messages %}
						{% for message in chat.messages %}
						<div class="message {% if message.author_id == session.user_id %}message-own{% else %}message-other{% endif %}">
							<div class="message-content">
								<p>{{ message.content }}</p>
								<span class="message-time">{{ message.created_at.strftime('%H:%M') if message.created_at else '' }}</span>
							</div>
						</div>
						{% endfor %}
					{% else %}
						<div class="no-messages">
							<p>Пока нет сообщений. Начните общение!</p>
						</div>
					{% endif %}
				</div>
				
				<div class="chat-input">
					<form method="POST" action="{{ url_for('main.send_message', chat_id=chat.id) }}" class="message-form">
						<div class="input-group">
							<input type="text" name="content" placeholder="Введите сообщение..." required class="message-input">
							<button type="submit" class="btn btn-primary">Отправить</button>
						</div>
					</form>
				</div>
			</section>
			{% endif %}
		</main>
	</div>

	<script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>
